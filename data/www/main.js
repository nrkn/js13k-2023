(()=>{"use strict";const e=160,t=(e,t)=>({x:0|e,y:0|t}),i=(e,t,i,a,n,o)=>Math.abs(e*(a-o)+i*(o-t)+n*(t-a)),a=(e,t,a,n)=>i(t.x,t.y,a.x,a.y,n.x,n.y)===i(e.x,e.y,a.x,a.y,n.x,n.y)+i(t.x,t.y,e.x,e.y,n.x,n.y)+i(t.x,t.y,a.x,a.y,e.x,e.y),n=(e,i,n)=>{e=t(e.x,e.y),i=t(i.x,i.y),n=t(n.x,n.y);const o=[],r=Math.min(e.x,i.x,n.x),h=Math.max(e.x,i.x,n.x),l=Math.min(e.y,i.y,n.y),s=Math.max(e.y,i.y,n.y);for(let t=r;t<=h;t++)for(let r=l;r<=s;r++)a({x:t,y:r},e,i,n)&&o.push({x:0|t,y:0|r});return o},o=(e,t,i,a)=>[...n(e,t,i),...n(e,i,a)],r=(e,i,a,n)=>{e|=0,i|=0,n|=0;const o=[];for(let r=-(a|=0);r<=a;r++){const h=n*Math.sqrt(1-r*r/(a*a));for(let a=-h;a<=h;a++)o.push(t(e+r,i+a))}return o},h=c;h.width=e,h.height=e;const l=h.getContext("2d"),s=(t=innerWidth,i=innerHeight)=>{const a=t>i?i/e:t/e;h.width=Math.floor(t/a),h.height=Math.floor(i/a)};addEventListener("resize",(()=>s()));const d={startTime:0,lastTime:0,elapsedTime:0,deltaTime:0},m=[],g=new Image,y=[],x={skyImage:g,mountainImage:g,groundImage:g,treeImage:g,girlIdleFrames:y,girlWalkFrames:y},p={type:2,x:0,y:0,image:void 0,anim:"idle",speed:0,acceleration:0,direction:1,intersects:1},f=e=>{"ArrowLeft"===e.key?(p.direction=-1,p.acceleration=.5):"ArrowRight"===e.key&&(p.direction=1,p.acceleration=-.5)},w=e=>{"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||(p.acceleration=0)},u=(e,t)=>{const i=Math.floor(e.width/t),a=e.height,n=[];for(let o=0;o<t;o++){const t=document.createElement("canvas");t.width=i,t.height=a,t.getContext("2d").drawImage(e,o*i,0,i,a,0,0,i,a),n.push(t)}return n},M=e=>new Promise(((t,i)=>{const a=new Image;a.src=e,a.onload=()=>t(a),a.onerror=i})),k=e=>{let t;if(1===e.type||2===e.type){const i=e.image[e.anim];t=i.frames[i.frame]}else t=e.image;return t};let I=[];const v=e=>{d.startTime||(d.startTime=e,d.lastTime=e),d.elapsedTime=e-d.startTime,d.deltaTime=e-d.lastTime,d.lastTime=e,(e=>{(e=>{for(const e of m){if(1===e.type||2===e.type){const{elapsedTime:t}=d,i=e.image[e.anim],{duration:a,frames:n}=i,o=n.length,r=Math.floor(t/a*o)%o;i.frame=r}void 0!==e.speed&&void 0!==e.acceleration&&(e.speed+=e.acceleration,e.speed*=.95,e.x-=e.speed,Math.abs(e.speed)<.1?(e.speed=0,1!==e.type&&2!==e.type||(e.anim="idle")):1!==e.type&&2!==e.type||(e.anim="walk"))}})(),(()=>{I=[];for(let e=0;e<m.length;e++){const t=m[e];if(t.blocks||t.intersects)for(let i=0;i<m.length;i++){const a=m[i];if(e!==i&&(a.blocks||a.intersects)){const n=k(t),o=k(a),r=t.x,h=t.y,l=n.width,s=n.height,d=a.x,m=a.y,g=o.width,c=o.height;r<d+g&&r+l>d&&h<m+c&&h+s>m&&I.push([e,i])}}}})();for(let e=0;e<I.length;e++){const[t,i]=I[e],a=m[t];m[t].intersects&&m[i].blocks&&"number"==typeof a.speed&&(a.x+=a.speed,a.speed=0)}})(),(e=>{h.width=h.width;const t=h.width/2,i=h.height/2;for(const e of m){const a=k(e),n=e.moveSpeed?(1-e.moveSpeed)*p.x:0;let o,r=Math.floor(e.x+n-p.x-a.width/2+t);o=2===e.tiling?h.height-a.height:1===e.tiling?i-a.height/2+e.y:h.height-a.height-x.groundImage.height+e.y,2===e.type&&(r=t-a.width/2,o=h.height-a.height-x.groundImage.height);const s=(t,i)=>{l.save(),-1===e.direction?(l.translate(t+a.width,i),l.scale(-1,1),l.drawImage(a,0,0)):l.drawImage(a,t,i),l.restore()};if((e.tiling||r+a.width>0&&r<h.width)&&(s(r,o),e.tiling)){let e=r-a.width;for(;e+a.width>0;)s(e,o),e-=a.width;let t=r+a.width;for(;t<h.width;)s(t,o),t+=a.width}}l.fillStyle="white",l.font="12px monospace",l.fillText(`x: ${p.x.toFixed(2)}`,10,20),l.fillText(`speed: ${p.speed.toFixed(2)}`,10,40),l.fillText(`accel: ${p.acceleration.toFixed(2)}`,10,60)})(),requestAnimationFrame(v)};(async()=>{const e=await M("tree-100-100.png"),t=await M("tree2-100-100.png"),i=await M("gate-32-64.png"),a=await M("girl-idle.png"),n=await M("girl-walk.png");x.skyImage=((e=800,t=300,i=10,a="#33d5fe",n="#caebfb",o=20,h=40,l=10,s=20)=>{const d=document.createElement("canvas");d.width=e,d.height=t;const m=d.getContext("2d");m.fillStyle=a,m.fillRect(0,0,d.width,d.height);for(let e=0;e<i;e++){const e=Math.random()*d.width,t=Math.random()*d.height/2,i=3+Math.floor(3*Math.random());for(let a=0;a<i;a++){const i=o+Math.random()*h,a=l+Math.random()*s,g=(Math.random()-.5)*h,c=(Math.random()-.5)*s,y=r(e+g,t+c,i,a);m.fillStyle=n,y.forEach((({x:e,y:t})=>{e=(e+d.width)%d.width,t=(t+d.height)%d.height,m.fillRect(e,t,1,1)}))}}return d})(800,300),x.mountainImage=((e=800,t=300,i="#a4b1bd",a="#628099",n="#1f65a1",r=.5,h=.4,l=.3)=>{const s=document.createElement("canvas");s.width=e,s.height=t;const d=s.getContext("2d"),m=(i,a,n)=>{const r=t*a;let h=r+(Math.random()*n-n/2);for(let l=1;l<e;l++){let e=Math.random()*n-n/2;h>r+a*t-n&&(e=-1*Math.abs(e));let m=h+e;m=Math.min(r+a*t,m),m=Math.max(.1*t,m);const g=o({x:l-1,y:t-h},{x:l,y:t-m},{x:l,y:t},{x:l-1,y:t});d.fillStyle=i,g.forEach((({x:e,y:t})=>{e=(e+s.width)%s.width,t=(t+s.height)%s.height,d.fillRect(e,t,1,1)})),h=m}};return m(i,r,15),m(a,h,10),m(n,l,5),s})(800,300),x.groundImage=await M("ground-64-32.png"),x.girlIdleFrames=u(a,4),x.girlWalkFrames=u(n,6);const h={idle:{frames:x.girlIdleFrames,frame:0,duration:1e3},walk:{frames:x.girlWalkFrames,frame:0,duration:500}};p.image=h,m.push({type:0,x:0,y:0,image:x.skyImage,moveSpeed:.5,tiling:1},{type:0,x:0,y:0,image:x.mountainImage,moveSpeed:.8,tiling:1},{type:0,x:-1e4,y:0,image:i,blocks:1},{type:0,x:-1200,y:0,image:e},{type:1,x:100,y:0,image:h,anim:"idle",direction:-1},{type:0,x:150,y:2,image:t,moveSpeed:.95},{type:0,x:200,y:0,image:e},{type:0,x:1400,y:0,image:e},{type:0,x:1e4,y:0,image:i,blocks:1},{type:0,x:0,y:0,image:x.groundImage,moveSpeed:1,tiling:2},p),addEventListener("keydown",f),addEventListener("keyup",w),s(),requestAnimationFrame(v)})().catch(console.error)})();